
<!DOCTYPE html>
<html class="x-admin-sm">
    
    <head>
        <meta charset="UTF-8">
        <title>二维码管理</title>
        <meta name="renderer" content="webkit">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
        <link rel="stylesheet" href="./css/font.css">
        <link rel="stylesheet" href="./css/xadmin.css">
        <script type="text/javascript" src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
        <script src="./lib/layui/layui.js" charset="utf-8"></script>
        <script type="text/javascript" src="./js/xadmin.js"></script>
        <script type="text/javascript" src="./js/allajax.js"></script>
        <style>
          /* .pagenum{
            margin-left: 20px;
            padding-bottom: 30px;
          } */
          .xzbtn{
              border:1px solid #129D90;
              padding: 2px 10px;
              background: #ffffff;
              color: #129D90;
          }
        </style>
    </head>
    
    <body>
        <!-- <div class="x-nav">
            <span class="layui-breadcrumb">
                <a href="">首页</a>
                <a href="">演示</a>
                <a>
                    <cite>导航元素</cite></a>
            </span>
            <a class="layui-btn layui-btn-small" style="line-height:1.6em;margin-top:3px;float:right" onclick="location.reload()" title="刷新">
                <i class="layui-icon layui-icon-refresh" style="line-height:30px"></i>
            </a>
        </div> -->
        <div class="layui-fluid">
            <div class="layui-row layui-col-space15">
                <div class="layui-col-md12">
                    <div class="layui-card">
                        <div class="layui-card-body ">
                            <form  class="layui-form layui-col-space5">
                                <div style="float: left;width: auto;">
                                    <label class="layui-form-label">追踪二维码</label>
                                    <div  class="layui-input-inline layui-show-xs-block">
                                        <div style="margin-left: 0;" class="layui-input-block">
                                            <select id="stafflist" name="stafflist" lay-filter="aihao">
                                            </select>
                                        </div>
                                    </div>
                                    <div class="layui-btn" style="margin-left: 10px;" onclick="savecode(1)" lay-submit id="search_hash" >
                                            生成二维码</div>
                                </div>
                                <div style="float: left;width: auto;">
                                    <div style="float: left;" class="layui-input-inline layui-show-xs-block">
                                        <label style="margin: 0;" class="layui-form-label">产品二维码</label>
                                        <div  class="layui-input-block">
                                            <select id="batchlist"  name="batchlist" lay-filter="changepro">
                                            </select>
                                        </div>
                                    </div>
                                    <div class="layui-btn" style="margin-left: 10px;" onclick="savecode(2)" lay-submit id="search_hash" >
                                            生成二维码</div>
                                </div>
                                <div style="float: left;width: auto;">
                                    <div style="float: left;" class="layui-input-inline layui-show-xs-block">
                                        <label style="margin: 0;" class="layui-form-label">产品条形码</label>
                                        <div  class="layui-input-block">
                                            <select id="batchlisttwo" name="batchlisttwo" lay-filter="aihao">
                                            </select>
                                        </div>
                                    </div>
                                    <div class="layui-btn" style="margin-left: 10px;" onclick="savecode(4)" lay-submit id="search_hash" >
                                            生成条形码</div>
                                </div>
                                <div style="float: left;width: auto;">
                                    <div style="float: left;" class="layui-input-inline layui-show-xs-block">
                                        <label style="margin: 0;" class="layui-form-label">打卡二维码</label>
                                        <div class="layui-input-block">
                                            <select id="interest" name="interest" lay-filter="aihao">
                                                <!-- <option value="2">测试</option> -->
                                            </select>
                                        </div>
                                    </div>
                                    <div class="layui-btn" style="margin-left: 10px;" onclick="savecode(3)" lay-submit id="search_hash" >
                                            生成二维码</div>
                                </div>
                            </form>
                            <ul style="overflow: hidden;margin-left: 36px;margin-top: 300px;">
                                <li style="float: left;width: 160px;">
                                    <!-- <div id="cardtext">追踪二维码</div> -->
                                    <div style="z-index: -1;margin-bottom: 10px;" id="QR_Code"></div>
                                    <title id="btntextone" style="display: inline-block;margin-right: 20px;">追踪二维码</title><button onclick="dywemone(1)" class="xzbtn" type="submit">打印</button><button id="button" class="xzbtn" type="submit">下载</button>
                                </li>
                                <li style="float: left;margin-left:260px;width: 160px;">
                                    <!-- <div> 产品二维码</div> -->
                                    <div style="z-index: -1;margin-bottom: 10px;" id="QR_Codetwo"></div>
                                    <title id="btntexttwo" style="display: inline-block;margin-right: 20px;">产品二维码</title><button onclick="dywemone(2)" class="xzbtn" type="submit">打印</button><button id="buttonone" class="xzbtn" type="submit">下载</button>
                                </li>
                                <li style="float: left;margin-left:260px;width: 160px;">
                                    <!-- <div>打卡</div> -->
                                    <div style="z-index: -1;margin-bottom: 10px;" id="QR_Codethree"></div>
                                    <title id="btntexthree" style="display: inline-block;margin-right: 20px;">打卡二维码</title><button onclick="dywemone(3)" class="xzbtn" type="submit">打印</button><button id="buttontwo" class="xzbtn" type="submit">下载</button>
                                </li>
                                <!-- <li style="float: left;width: 160px;margin-left:260px;">      
                                </li> -->
                            </ul>
                            <div style="margin-left: 460px;">
                                <div>
                                    <svg style="width: 160px;" pointer-events="none" id="svgcode"></svg>
                                </div>
                                <title id="txmtext" style="display: inline-block;margin-right: 20px;">条形码</title><button class="xzbtn" onclick="change()"  type="submit">下载</button>
                            </div>
                            <div style="height: 0;overflow: hidden;">
                                <img id="imageone" src="" />
                            </div>
                            <!-- <div style="margin-top: 20px;"> 条形码</div>
                            <div>
                                <svg pointer-events="none" id="svgcode"></svg>
                            </div> -->
                            <!-- <button id="button" type="submit">下载二维码</button>
                            <button onclick="change()"  type="submit">下载条形码</button>
                            <div id="help-div" style="width: 300px;"></div> -->
                        </div>
                    </div>
                </div>
                <!-- <img src="./images/logo.png"> -->
            </div>
        </div>
    </body>
    <script src="http://www.jq22.com/jquery/jquery-migrate-1.2.1.min.js"></script>
     <script language="javascript" src="https://files.cnblogs.com/files/diyunfei/jquery.jqprint-0.3.js"></script>
    <script src="./js/jquery.qrcode.js" type="text/javascript"></script>
    <script src="./js/utf.js" type="text/javascript"></script>
    <script src="./js/svgToPng.js" type="text/javascript"></script>
    <script type="text/javascript" src="./js/JsBarcode.all.min.js"></script>
    <script>
        function init(textdetail,type) {
        // QR_Code 为显示二维码的div id
            if(type==1){
                $("#QR_Code").empty()
                $("#QR_Code").qrcode({
                                render : "canvas",    //设置渲染方式，有table和canvas，使用canvas方式渲染性能相对来说比较好
                                text: textdetail,    //扫描二维码后显示的内容,可以直接填一个网址，扫描二维码后自动跳向该链接
                                width : "160",               //二维码的宽度
                                height : "160",              //二维码的高度
                                background : "#ffffff",       //二维码的后景色
                                foreground : "#000000",        //二维码的前景色
                                src: './images/logo.png'             //二维码中间的图片
                        });
            }
            if(type==2){
                $("#QR_Codetwo").empty()
                $("#QR_Codetwo").qrcode({
                                render : "canvas",    //设置渲染方式，有table和canvas，使用canvas方式渲染性能相对来说比较好
                                text: textdetail,    //扫描二维码后显示的内容,可以直接填一个网址，扫描二维码后自动跳向该链接
                                width : "160",               //二维码的宽度
                                height : "160",              //二维码的高度
                                background : "#ffffff",       //二维码的后景色
                                foreground : "#000000",        //二维码的前景色
                                src: './images/logo.png'             //二维码中间的图片
                        });
            }
            if(type==3){
                $("#QR_Codethree").empty()
                $("#QR_Codethree").qrcode({
                                render : "canvas",    //设置渲染方式，有table和canvas，使用canvas方式渲染性能相对来说比较好
                                text: textdetail,    //扫描二维码后显示的内容,可以直接填一个网址，扫描二维码后自动跳向该链接
                                width : "160",               //二维码的宽度
                                height : "160",              //二维码的高度
                                background : "#ffffff",       //二维码的后景色
                                foreground : "#000000",        //二维码的前景色
                                src: './images/logo.png'             //二维码中间的图片
                        });
            }
        }
        // init();
        function savecode(type){
            if(type==1){
                if($('#stafflist').val()!=''&&$('#stafflist').val()!=null){
                    $('#btntextone').html($("#stafflist").find("option:selected").text()+'二维码')
                    let nowtime=new Date().getTime()
                    let codeurl ='http://ws.zhanchengwlkj.com/qrcode/gzh/prodzc.html?typeid='+$('#stafflist').val()+'&nowtime='+nowtime
                    init(codeurl,1)
                }else{
                    layer.msg('员工未选择', {icon: 5})
                }
                console.log($('#stafflist').val())
            }else if(type==2){
                if($('#batchlist').val()!=''&&$('#batchlist').val()!=null){
                    $('#btntexttwo').html($("#batchlist").find("option:selected").text()+'二维码')
                    let codeurl ='http://hcfzkj.zhanchengwlkj.com/pc/caseDetails.html?pid='+$('#batchlist').val()
                    init(codeurl,2)
                    // options = {
                    //     // format:"CODE128",
                    //     // displayValue:true,
                    //     text:" ",
                    //     // fontSize:18,
                    //     height:100,
                    //     width:1
                    // };
                    // let dytext = ''+$("#batchlist").find("option:selected").text()
                    // JsBarcode("#svgcode",dytext,options);
                    // $('#svgcode').css('width','200px')
                }else{
                    layer.msg('产品未选择', {icon: 5})
                }
            }else if(type==4){
                options = {
                        // format:"CODE128",
                        // displayValue:true,
                        text:" ",
                        // fontSize:18,
                        height:100,
                        width:1
                    };
                    // txmtext
                    $('#txmtext').html($("#batchlisttwo").find("option:selected").text()+'条形码')
                    let dytext =$("#batchlisttwo").val()
                    JsBarcode("#svgcode",dytext,options);
            }else{
                if($('#interest').val()!=''&&$('#interest').val()!=null){
                    console.log($('#interest').val())
                    $('#btntexthree').html($("#interest").find("option:selected").text()+'二维码')
                    // let codeurl ='http://ws.zhanchengwlkj.com/qrcode/gzh/login.html?typeid='+$('#interest').val()
                    let codeurl ="https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxf2677d625e6881f4&redirect_uri=http://ws.zhanchengwlkj.com/qrcode/gzh/index.html?phone=0&response_type=code&scope=snsapi_userinfo&state="+$('#interest').val()+"#wechat_redirect"
                    init(codeurl,3)
                }else{
                    layer.msg('设备未选择', {icon: 5})
                }
            }
        }
        // $("#svgcode").JsBarcode('Hi!');
        layui.use(['laydate', 'laypage', 'layer', 'table', 'carousel', 'upload', 'element', 'slider','form'], function(){
                var laydate = layui.laydate //日期
                ,laypage = layui.laypage //分页
                ,layer = layui.layer //弹层
                ,table = layui.table //表格
                ,carousel = layui.carousel //轮播
                ,upload = layui.upload //上传
                ,element = layui.element //元素操作
                ,slider = layui.slider //滑块
                ,form = layui.form
            
            //监听Tab切换
            form.on('select(changepro)', function(data){
                getpclist(data.value)           // getprotwo(data.value)
                            console.log(data)

            })
            element.on('tab(demo)', function(data){
                layer.tips('切换了 '+ data.index +'：'+ this.innerHTML, this, {
                tips: 1
                });
            });
            //监听头工具栏事件
            })
            function getpclist(shopid){
                    _ajax({
                        url : "/productBatch/list",  // url---->地址
                        type : "GET",   // type ---> 请求方式
                        async : true,   // async----> 同步：false，异步：true 
                        data : {        //传入信息
                            current:1,
                            size:10000,
                            id:1000
                        },
                        success : function(data){
                            let datastwo =JSON.parse(data);
                            // batchlisttwo
                            console.log(datastwo)
                            $('#batchlisttwo').empty()
                            for(let i=0;i<datastwo.data.records.length;i++){
                                // console.log(datastwo[i].title)
                                // stafflist
                                $('#batchlisttwo').append('<option value="'+datastwo.data.records[i].number+'">'+datastwo.data.records[i].name+'</option>')
                            }
                            console.log(datastwo)
                            renderForm()
                        }
                    });

                }
            window.onload = function () {
                // 按钮点击事件
                $("#button").click(function () {
                    var canvasImg = document.getElementsByTagName('canvas')[0];
                    var img =convertCanvasToImage(canvasImg);
                    $('#QR_Code').empty();
                    $('#QR_Code').append(img);
                    downLoadCode();
                    // alert("下载完成");
                })
                // downbutton
                $("#buttonone").click(function () {
                    var canvasImgone
                    if( document.getElementsByTagName('canvas').length==1){
                        canvasImgone = document.getElementsByTagName('canvas')[0];
                    }else{
                        canvasImgone = document.getElementsByTagName('canvas')[1];
                    }
                    var img =convertCanvasToImage(canvasImgone);
                    $('#QR_Codetwo').empty();
                    $('#QR_Codetwo').append(img);
                    downLoadCodeone();
                    // alert("下载完成");
                })
                // batchlist
                $("#buttontwo").click(function () {
                    var canvasImgtwo
                    if( document.getElementsByTagName('canvas').length==1){
                        canvasImgtwo = document.getElementsByTagName('canvas')[0];
                    }else if(document.getElementsByTagName('canvas').length==2){
                        canvasImgtwo = document.getElementsByTagName('canvas')[1];
                    }else{

                    }
                    // var canvasImg = document.getElementsByTagName('canvas')[0];
                    var img =convertCanvasToImage(canvasImgtwo);
                    $('#QR_Codethree').empty();
                    $('#QR_Codethree').append(img);
                    downLoadCodetwo();
                    // alert("下载完成");
                })
                function getalllist(){
                    _ajax({
                        url : "/products",  // url---->地址
                        type : "GET",   // type ---> 请求方式
                        async : true,   // async----> 同步：false，异步：true 
                        data : {        //传入信息
                            current:1,
                            size:1000,
                            // status:0
                        },
                        success : function(data){
                            let datastwo =JSON.parse(data);
                            let dataslisttwo = datastwo.data.records
                            console.log(dataslisttwo)
                            for(let i=0;i<dataslisttwo.length;i++){
                                console.log('打印')
                                
                                if(i==0){
                                    getpclist(dataslisttwo[i].pid)
                                }
                                // $('#stafflist').append('<option value="'+dataslisttwo[i].pid+'">'+dataslisttwo[i].productName+'</option>')
                                $('#batchlist').append('<option value="'+dataslisttwo[i].pid+'">'+dataslisttwo[i].productName+'</option>')
                            }
                            renderForm()
                        }
                    });
                    _ajax({
                        url : "/employeess/list",  // url---->地址
                        type : "GET",   // type ---> 请求方式
                        async : true,   // async----> 同步：false，异步：true 
                        data : {        //传入信息
                            current:1,
                            size:1000,
                            // status:0
                        },
                        success : function(data){
                            let datastwo =JSON.parse(data);
                            let dataslisttwo = datastwo.data.records
                            console.log(dataslisttwo)
                            for(let i=0;i<dataslisttwo.length;i++){
                                console.log('打印')
                                
                                // if(i==0){
                                //     getpclist(dataslisttwo[i].pid)
                                // }
                                $('#stafflist').append('<option value="'+dataslisttwo[i].id+'">'+dataslisttwo[i].name+'</option>')
                                // $('#batchlist').append('<option value="'+dataslisttwo[i].pid+'">'+dataslisttwo[i].productName+'</option>')
                            }
                            renderForm()
                        }
                    });
                    _ajax({
                        url : "/group/getAll",  // url---->地址
                        type : "GET",   // type ---> 请求方式
                        async : true,   // async----> 同步：false，异步：true 
                        data : {        //传入信息
                        },
                        success : function(data){
                            let datastwo =JSON.parse(data);
                            let dataslisttwo = datastwo.data
                            console.log("设备组")
                            console.log(dataslisttwo)
                            for(let i=0;i<dataslisttwo.length;i++){
                                console.log(dataslisttwo[i].title)
                                // stafflist
                                $('#interest').append('<option value="'+dataslisttwo[i].gid+'">'+dataslisttwo[i].title+'</option>')
                            }
                            renderForm()
                        }
                    });
                }
                // getpclist()
                getalllist()
    }
    var svg = document.querySelector('svg');
    var svgToPng = new svgToPng(svg);
    function change(){
        console.log('打印')
        svgToPng.change('产品条形码');
        console.log(svgToPng)
    }
    //从canvas中提取图片image
    function convertCanvasToImage(canvas) {
        //新Image对象，可以理解为DOM
        var image = new Image();
        // canvas.toDataURL 返回的是一串Base64编码的URL，当然,浏览器自己肯定支持
        // 指定格式PNG
        image.src = canvas.toDataURL("image/png");
        return image;
    };
 
    function dywemone(type){
        var img = document.getElementById("imageone"); /// get image element
        var canvas  = document.getElementById("QR_Code").getElementsByTagName("canvas")[0];  /// get canvas element
        if(type==2){
            canvas=document.getElementById("QR_Codetwo").getElementsByTagName("canvas")[0]
        }else if(type==3){
            canvas=document.getElementById("QR_Codethree").getElementsByTagName("canvas")[0]
        }else if(type==4){
            
        }
        img.src = canvas.toDataURL();                     /// update image
         
         $("#imageone").jqprint({
             debug:false,
             importCSS:false,
            printContainer:true,
             operaSupport:false
        });
    }
    // 下载二维码
    function downLoadCode(){
        var img = $('#QR_Code').children('img').attr("src");
        var alink = document.createElement("a");
        alink.href = img;
        alink.download = "追踪.png";
        alink.click();
    }
    function downLoadCodeone(){
        var img = $('#QR_Codetwo').children('img').attr("src");
        var alink = document.createElement("a");
        alink.href = img;
        alink.download = "产品.png";
        alink.click();
    }
    function downLoadCodetwo(){
        var img = $('#QR_Codethree').children('img').attr("src");
        var alink = document.createElement("a");
        alink.href = img;
        alink.download = "打卡.png";
        alink.click();
    }
    </script>

</html>